{"version":3,"file":"EiFgVSs5.js","sources":["../../src/util/sleep.js","../../src/util/request.js","../../src/store/auth.js"],"sourcesContent":["function sleep(ms) {\n  // eslint-disable-next-line\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nexport default sleep;\n","import Config from '@/config';\nimport sleep from '@/util/sleep';\n\nfunction getApiTimeout(timeout) {\n  if (typeof timeout === 'number') {\n    return timeout;\n  }\n\n  if (Config.api.timeoutMs === 'number') {\n    return Config.api.timeoutMs;\n  }\n\n  return 15000;\n}\n\nfunction getApiDelay(delay) {\n  if (typeof delay === 'number') {\n    return delay;\n  }\n\n  if (Config.api.delayMs === 'number') {\n    return Config.api.delayMs;\n  }\n\n  return 1000;\n}\n\nasync function fetchWithTimeout(resource, options = {}, timeout = null) {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), getApiTimeout(timeout));\n\n  const response = await fetch(resource, {\n    ...options,\n    signal: controller.signal,\n  });\n\n  clearTimeout(timeoutId);\n\n  return response;\n}\n\nasync function request(resource, opt = {}, timeout = null, delay = null) {\n  const startTime = performance.now();\n\n  const options = {\n    ...opt,\n    headers: opt.headers || { 'Content-Type': 'application/json' },\n    method: opt.method || 'GET',\n  };\n\n  if (options.headers.Authorization === undefined && Config.api.key && Config.api.key.length) {\n    options.headers.Authorization = Config.api.key;\n  }\n\n  if (options.method.toUpperCase() === 'GET' && typeof options.body === 'object' && options.body !== null) {\n    const url = new URL(resource, window.location.origin);\n    Object.entries(options.body).forEach(([key, value]) => {\n      if (value === null || value === undefined) {\n        return false;\n      }\n      if (typeof value === 'object') {\n        url.searchParams.append(key, JSON.stringify(value));\n      } else {\n        url.searchParams.append(key, value);\n      }\n    });\n    resource = url.toString();\n    delete options.body;\n  }\n\n  if (typeof options.body === 'object' && !(options.body instanceof FormData)) {\n    options.body = JSON.stringify(options.body);\n  }\n\n  const result = {\n    code: null,\n    status: null,\n    message: null,\n    data: null,\n    error: null,\n  };\n\n  let response = {};\n\n  try {\n    response = await fetchWithTimeout(resource, options, getApiTimeout(timeout));\n    result.code = response.status;\n  } catch {\n    result.status = 'error';\n    result.message = 'Request failed: resource is not reachable or response time was exceeded';\n    return result;\n  }\n\n  try {\n    const responseData = await response.json() || {};\n    if (responseData.constructor.name === 'Object') {\n      Object.assign(result, responseData);\n    }\n\n    result.status = responseData.status || null;\n    result.message = responseData.message || null;\n    result.data = responseData.data || responseData.payload || responseData || null;\n  } catch {\n    result.status = 'error';\n    result.message = 'Request failed: the response is not valid JSON';\n    return result;\n  }\n\n  const endTime = performance.now();\n  const differenceTime = endTime - startTime;\n  const delayTime = getApiDelay(delay);\n\n  if (differenceTime < delayTime) {\n    await sleep(delayTime - differenceTime);\n  }\n\n  return result;\n}\n\nexport {\n  fetchWithTimeout,\n  request,\n};\n\nexport default request;\n","import Config from '@/config';\nimport { useUserStore } from '@/store';\nimport { request as requestUtil } from '@/util/request';\nimport { getStorage, setStorage } from '@/util/storage';\nimport { defineStore } from 'pinia';\nimport { computed, ref, watch } from 'vue';\n\nconst useAuthStore = defineStore('authStore', () => {\n  const storageKey = 'auth-data';\n\n  const userStore = useUserStore();\n\n  const data = ref(getStorage(storageKey, 'local') || {});\n\n  const accessToken = computed(() => data.value.accessToken);\n  const isAuthenticated = computed(() => !!accessToken.value);\n\n  watch(\n    () => data.value,\n    () => {\n      setStorage(storageKey, data.value, 'local');\n    },\n    { deep: true },\n  );\n\n  function flush() {\n    data.value = {};\n    return true;\n  }\n\n  async function login(body = {}) {\n    const url = `${Config.api.backend}/auth/login`;\n    const options = {\n      method: 'POST',\n      credentials: 'include',\n      body: {\n        ...body,\n      },\n    };\n\n    const result = await requestUtil(url, options);\n    if (result.status !== 'success') {\n      return false;\n    }\n\n    data.value.accessToken = result.data.accessToken;\n    Object.assign(userStore.dataSession, result.data.user);\n\n    return true;\n  }\n\n  async function logout() {\n    const url = `${Config.api.backend}/auth/logout`;\n    const options = {\n      method: 'POST',\n      credentials: 'include',\n      body: {},\n    };\n\n    await requestUtil(url, options);\n    userStore.flush();\n    flush();\n\n    return true;\n  }\n\n  async function request(resource, options = {}, timeout = null, delay = null) {\n    if (!options.headers) {\n      options.headers = {\n        'Content-Type': 'application/json',\n      };\n    }\n\n    if (accessToken.value) {\n      options.headers.Authorization = `Bearer ${accessToken.value}`;\n    }\n\n    let result = await requestUtil(resource, options, timeout, delay);\n    if (result.code !== 401) {\n      return result;\n    }\n\n    const resultRefresh = await refresh();\n    if (!resultRefresh) {\n      flush();\n      userStore.flushSession();\n      return result;\n    }\n\n    options.headers.Authorization = `Bearer ${resultRefresh}`;\n\n    result = await requestUtil(resource, options, timeout, delay);\n    if (result.code === 401) {\n      flush();\n      userStore.flushSession();\n      return result;\n    }\n\n    data.value.accessToken = resultRefresh;\n\n    return result;\n  }\n\n  async function refresh() {\n    const url = `${Config.api.backend}/auth/refresh`;\n    const options = {\n      method: 'POST',\n      credentials: 'include',\n      body: {},\n    };\n\n    const result = await requestUtil(url, options);\n    if (result.status !== 'success') {\n      return false;\n    }\n\n    return result.data.accessToken;\n  }\n\n  return {\n    data,\n    accessToken,\n    isAuthenticated,\n    flush,\n    login,\n    logout,\n    request,\n    refresh,\n  };\n});\n\nexport default useAuthStore;\n"],"names":["sleep","ms","resolve","getApiTimeout","timeout","Config","getApiDelay","delay","fetchWithTimeout","resource","options","controller","timeoutId","response","request","opt","startTime","url","key","value","result","responseData","differenceTime","delayTime","useAuthStore","defineStore","storageKey","userStore","useUserStore","data","ref","getStorage","accessToken","computed","isAuthenticated","watch","setStorage","flush","login","body","requestUtil","logout","resultRefresh","refresh"],"mappings":"mFAAA,SAASA,EAAMC,EAAI,CAEjB,OAAO,IAAI,QAASC,GAAY,WAAWA,EAASD,CAAE,CAAC,CACzD,CCAA,SAASE,EAAcC,EAAS,CAC9B,OAAI,OAAOA,GAAY,SACdA,EAGLC,EAAO,IAAI,YAAc,SACpBA,EAAO,IAAI,UAGb,IACT,CAEA,SAASC,EAAYC,EAAO,CAC1B,OAAI,OAAOA,GAAU,SACZA,EAGLF,EAAO,IAAI,UAAY,SAClBA,EAAO,IAAI,QAGb,GACT,CAEA,eAAeG,EAAiBC,EAAUC,EAAU,CAAA,EAAIN,EAAU,KAAM,CACtE,MAAMO,EAAa,IAAI,gBACjBC,EAAY,WAAW,IAAMD,EAAW,QAASR,EAAcC,CAAO,CAAC,EAEvES,EAAW,MAAM,MAAMJ,EAAU,CACrC,GAAGC,EACH,OAAQC,EAAW,MACvB,CAAG,EAED,oBAAaC,CAAS,EAEfC,CACT,CAEA,eAAeC,EAAQL,EAAUM,EAAM,CAAA,EAAIX,EAAU,KAAMG,EAAQ,KAAM,CACvE,MAAMS,EAAY,YAAY,IAAG,EAE3BN,EAAU,CACd,GAAGK,EACH,QAASA,EAAI,SAAW,CAAE,eAAgB,kBAAkB,EAC5D,OAAQA,EAAI,QAAU,KAC1B,EAME,GAJIL,EAAQ,QAAQ,gBAAkB,QAAaL,EAAO,IAAI,KAAOA,EAAO,IAAI,IAAI,SAClFK,EAAQ,QAAQ,cAAgBL,EAAO,IAAI,KAGzCK,EAAQ,OAAO,YAAW,IAAO,OAAS,OAAOA,EAAQ,MAAS,UAAYA,EAAQ,OAAS,KAAM,CACvG,MAAMO,EAAM,IAAI,IAAIR,EAAU,OAAO,SAAS,MAAM,EACpD,OAAO,QAAQC,EAAQ,IAAI,EAAE,QAAQ,CAAC,CAACQ,EAAKC,CAAK,IAAM,CACrD,GAAIA,GAAU,KACZ,MAAO,GAEL,OAAOA,GAAU,SACnBF,EAAI,aAAa,OAAOC,EAAK,KAAK,UAAUC,CAAK,CAAC,EAElDF,EAAI,aAAa,OAAOC,EAAKC,CAAK,CAEtC,CAAC,EACDV,EAAWQ,EAAI,SAAQ,EACvB,OAAOP,EAAQ,IACjB,CAEI,OAAOA,EAAQ,MAAS,UAAY,EAAEA,EAAQ,gBAAgB,YAChEA,EAAQ,KAAO,KAAK,UAAUA,EAAQ,IAAI,GAG5C,MAAMU,EAAS,CACb,KAAM,KACN,OAAQ,KACR,QAAS,KACT,KAAM,KACN,MAAO,IACX,EAEE,IAAIP,EAAW,CAAA,EAEf,GAAI,CACFA,EAAW,MAAML,EAAiBC,EAAUC,EAASP,EAAcC,CAAO,CAAC,EAC3EgB,EAAO,KAAOP,EAAS,MACzB,MAAQ,CACN,OAAAO,EAAO,OAAS,QAChBA,EAAO,QAAU,0EACVA,CACT,CAEA,GAAI,CACF,MAAMC,EAAe,MAAMR,EAAS,KAAI,GAAM,CAAA,EAC1CQ,EAAa,YAAY,OAAS,UACpC,OAAO,OAAOD,EAAQC,CAAY,EAGpCD,EAAO,OAASC,EAAa,QAAU,KACvCD,EAAO,QAAUC,EAAa,SAAW,KACzCD,EAAO,KAAOC,EAAa,MAAQA,EAAa,SAAWA,GAAgB,IAC7E,MAAQ,CACN,OAAAD,EAAO,OAAS,QAChBA,EAAO,QAAU,iDACVA,CACT,CAGA,MAAME,EADU,YAAY,IAAG,EACEN,EAC3BO,EAAYjB,EAAYC,CAAK,EAEnC,OAAIe,EAAiBC,GACnB,MAAMvB,EAAMuB,EAAYD,CAAc,EAGjCF,CACT,CC9GK,MAACI,EAAeC,EAAY,YAAa,IAAM,CAClD,MAAMC,EAAa,YAEbC,EAAYC,EAAY,EAExBC,EAAOC,EAAIC,EAAWL,EAAY,OAAO,GAAK,EAAE,EAEhDM,EAAcC,EAAS,IAAMJ,EAAK,MAAM,WAAW,EACnDK,EAAkBD,EAAS,IAAM,CAAC,CAACD,EAAY,KAAK,EAE1DG,EACE,IAAMN,EAAK,MACX,IAAM,CACJO,EAAWV,EAAYG,EAAK,MAAO,OAAO,CAC5C,EACA,CAAE,KAAM,EAAI,CAChB,EAEE,SAASQ,GAAQ,CACf,OAAAR,EAAK,MAAQ,CAAA,EACN,EACT,CAEA,eAAeS,EAAMC,EAAO,GAAI,CAC9B,MAAMtB,EAAM,GAAGZ,EAAO,IAAI,OAAO,cAC3BK,EAAU,CACd,OAAQ,OACR,YAAa,UACb,KAAM,CACJ,GAAG6B,CACX,CACA,EAEUnB,EAAS,MAAMoB,EAAYvB,EAAKP,CAAO,EAC7C,OAAIU,EAAO,SAAW,UACb,IAGTS,EAAK,MAAM,YAAcT,EAAO,KAAK,YACrC,OAAO,OAAOO,EAAU,YAAaP,EAAO,KAAK,IAAI,EAE9C,GACT,CAEA,eAAeqB,GAAS,CACtB,MAAMxB,EAAM,GAAGZ,EAAO,IAAI,OAAO,eAOjC,aAAMmC,EAAYvB,EANF,CACd,OAAQ,OACR,YAAa,UACb,KAAM,CAAA,CACZ,CAEkC,EAC9BU,EAAU,MAAK,EACfU,EAAK,EAEE,EACT,CAEA,eAAevB,EAAQL,EAAUC,EAAU,CAAA,EAAIN,EAAU,KAAMG,EAAQ,KAAM,CACtEG,EAAQ,UACXA,EAAQ,QAAU,CAChB,eAAgB,kBACxB,GAGQsB,EAAY,QACdtB,EAAQ,QAAQ,cAAgB,UAAUsB,EAAY,KAAK,IAG7D,IAAIZ,EAAS,MAAMoB,EAAY/B,EAAUC,EAASN,EAASG,CAAK,EAChE,GAAIa,EAAO,OAAS,IAClB,OAAOA,EAGT,MAAMsB,EAAgB,MAAMC,EAAO,EAUnC,MATI,CAACD,IAMLhC,EAAQ,QAAQ,cAAgB,UAAUgC,CAAa,GAEvDtB,EAAS,MAAMoB,EAAY/B,EAAUC,EAASN,EAASG,CAAK,EACxDa,EAAO,OAAS,MAClBiB,EAAK,EACLV,EAAU,aAAY,EACfP,IAGTS,EAAK,MAAM,YAAca,EAElBtB,EACT,CAEA,eAAeuB,GAAU,CACvB,MAAM1B,EAAM,GAAGZ,EAAO,IAAI,OAAO,gBAO3Be,EAAS,MAAMoB,EAAYvB,EANjB,CACd,OAAQ,OACR,YAAa,UACb,KAAM,CAAA,CACZ,CAEiD,EAC7C,OAAIG,EAAO,SAAW,UACb,GAGFA,EAAO,KAAK,WACrB,CAEA,MAAO,CACL,KAAAS,EACA,YAAAG,EACA,gBAAAE,EACA,MAAAG,EACA,MAAAC,EACA,OAAAG,EACJ,QAAI3B,EACA,QAAA6B,CACJ,CACA,CAAC"}