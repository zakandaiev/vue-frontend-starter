import{C as d,m as g,n as O,p as w,q as A,s as j,j as k,x as q,h as C,y as P,z as b}from"./BxDW35qP.js";function $(s){return new Promise(r=>setTimeout(r,s))}function S(s){return w(s)?s:d.api.timeoutMs??15e3}function v(s){return w(s)?s:d.api.delayMs??500}async function z(s,r={},o=null){const c=new AbortController,f=setTimeout(()=>c.abort(),S(o)),t=await fetch(s,{...r,signal:c.signal});return clearTimeout(f),t}async function p(s,r={},o=null,c=null){const f=performance.now(),t={...r,headers:r.headers||{"Content-Type":"application/json"},method:r.method||"GET"};if(t.headers.Authorization===void 0&&d.api.key&&(t.headers.Authorization=d.api.key),t.method.toUpperCase()==="GET"&&g(t.body)){const e=new URL(s,window.location.origin);Object.entries(t.body).forEach(([u,a])=>{if(a==null)return!1;O(a)||g(a)?e.searchParams.append(u,JSON.stringify(a)):e.searchParams.append(u,a)}),s=e.toString(),delete t.body}g(t.body)&&!(t.body instanceof FormData)&&(t.body=JSON.stringify(t.body));const n={code:null,status:null,message:null,data:null,error:null};let h={};try{h=await z(s,t,S(o)),n.code=h.status}catch{return n.status="error",n.message="Request failed: resource is not reachable or response time was exceeded",n}try{const e=await h.json()||{};e.constructor.name==="Object"&&Object.assign(n,e),n.status=e.status||null,n.message=e.message||null,n.data=e.data||e.payload||e||null}catch{return n.status="error",n.message="Request failed: the response is not valid JSON",n}const m=performance.now()-f,i=v(c);return m<i&&await $(i-m),n}const R=A("authStore",()=>{const s="auth-data",r=j(),o=k(q(s,"local")||{}),c=b(()=>o.value.accessToken),f=b(()=>!!c.value);C(()=>o.value,()=>{P(s,o.value,"local")},{deep:!0});function t(){return o.value={},!0}async function n(i={}){const e=`${d.api.url}/auth/login`,u={method:"POST",credentials:"include",body:{...i}},a=await p(e,u);return a.status!=="success"?!1:(o.value.accessToken=a.data.accessToken,Object.assign(r.dataSession,a.data.user),!0)}async function h(){const i=`${d.api.url}/auth/logout`;return await p(i,{method:"POST",credentials:"include",body:{}}),r.flush(),t(),!0}async function T(i,e={},u=null,a=null){e.headers||(e.headers={"Content-Type":"application/json"}),c.value&&(e.headers.Authorization=`Bearer ${c.value}`);let l=await p(i,e,u,a);if(l.code!==401)return l;const y=await m();return!y||(e.headers.Authorization=`Bearer ${y}`,l=await p(i,e,u,a),l.code===401)?(t(),r.flushSession(),l):(o.value.accessToken=y,l)}async function m(){const i=`${d.api.url}/auth/refresh`,u=await p(i,{method:"POST",credentials:"include",body:{}});return u.status!=="success"?!1:u.data.accessToken}return{data:o,accessToken:c,isAuthenticated:f,flush:t,login:n,logout:h,request:T,refresh:m}});export{R as u};
