import{C as c,l as w,m as S,i as k,n as j,h as O,s as A,p as g}from"./DN8Vbk2x.js";function v(n){return new Promise(a=>setTimeout(a,n))}function T(n){return typeof n=="number"?n:c.api.timeoutMs==="number"?c.api.timeoutMs:15e3}function C(n){return typeof n=="number"?n:c.api.delayMs==="number"?c.api.delayMs:1e3}async function P(n,a={},r=null){const l=new AbortController,f=setTimeout(()=>l.abort(),T(r)),t=await fetch(n,{...a,signal:l.signal});return clearTimeout(f),t}async function m(n,a={},r=null,l=null){const f=performance.now(),t={...a,headers:a.headers||{"Content-Type":"application/json"},method:a.method||"GET"};if(t.headers.Authorization===void 0&&c.api.key&&c.api.key.length&&(t.headers.Authorization=c.api.key),t.method.toUpperCase()==="GET"&&typeof t.body=="object"&&t.body!==null){const e=new URL(n,window.location.origin);Object.entries(t.body).forEach(([i,o])=>{if(o==null)return!1;typeof o=="object"?e.searchParams.append(i,JSON.stringify(o)):e.searchParams.append(i,o)}),n=e.toString(),delete t.body}typeof t.body=="object"&&!(t.body instanceof FormData)&&(t.body=JSON.stringify(t.body));const s={code:null,status:null,message:null,data:null,error:null};let h={};try{h=await P(n,t,T(r)),s.code=h.status}catch{return s.status="error",s.message="Request failed: resource is not reachable or response time was exceeded",s}try{const e=await h.json()||{};e.constructor.name==="Object"&&Object.assign(s,e),s.status=e.status||null,s.message=e.message||null,s.data=e.data||e.payload||e||null}catch{return s.status="error",s.message="Request failed: the response is not valid JSON",s}const p=performance.now()-f,u=C(l);return p<u&&await v(u-p),s}const q=w("authStore",()=>{const n="auth-data",a=S(),r=k(j(n,"local")||{}),l=g(()=>r.value.accessToken),f=g(()=>!!l.value);O(()=>r.value,()=>{A(n,r.value,"local")},{deep:!0});function t(){return r.value={},!0}async function s(u={}){const e=`${c.api.backend}/auth/login`,i={method:"POST",credentials:"include",body:{...u}},o=await m(e,i);return o.status!=="success"?!1:(r.value.accessToken=o.data.accessToken,Object.assign(a.dataSession,o.data.user),!0)}async function h(){const u=`${c.api.backend}/auth/logout`;return await m(u,{method:"POST",credentials:"include",body:{}}),a.flush(),t(),!0}async function b(u,e={},i=null,o=null){e.headers||(e.headers={"Content-Type":"application/json"}),l.value&&(e.headers.Authorization=`Bearer ${l.value}`);let d=await m(u,e,i,o);if(d.code!==401)return d;const y=await p();return!y||(e.headers.Authorization=`Bearer ${y}`,d=await m(u,e,i,o),d.code===401)?(t(),a.flushSession(),d):(r.value.accessToken=y,d)}async function p(){const u=`${c.api.backend}/auth/refresh`,i=await m(u,{method:"POST",credentials:"include",body:{}});return i.status!=="success"?!1:i.data.accessToken}return{data:r,accessToken:l,isAuthenticated:f,flush:t,login:s,logout:h,request:b,refresh:p}});export{q as u};
//# sourceMappingURL=EiFgVSs5.js.map
